#!/bin/bash

## Description: Install Varbase using drush.
## Usage: install-varbase minimal|full|demo
## Example: ddev install-varbase minimal\nddev install-varbase full\nddev install-varbase demo
## Aliases: varbase:install
## Flags: []
## AutocompleteTerms: ["minimal","full","demo"]

# Configuration
ADMIN_USER="webmaster"
ADMIN_EMAIL="webmaster@vardot.com"
DEFAULT_LOCALE="en"

# Validate arguments.
if [[ $# -eq 0 ]]; then
  echo "Error: Install type is required"
  echo "Usage: install-varbase minimal|full|demo"
  exit 1
fi

if [[ $# -gt 1 ]]; then
  echo "Error: Too many arguments"
  echo "Usage: install-varbase minimal|full|demo"
  exit 1
fi

if [[ "$1" == "minimal" || "$1" == "full" || "$1" == "demo" ]]; then
  INSTALL_TYPE="$1"
else
  echo "Error: Invalid install type '$1'"
  echo "Usage: install-varbase minimal|full|demo"
  exit 1
fi

echo "Installing Varbase ($INSTALL_TYPE)..."
echo " Project Basename: $DDEV_PROJECT"

# Generate a password for the webmaster user.
webmaster_password="$(tr -dc 'A-Za-z0-9!"#$%&'\''()*+,-./:;<=>?@[\]^_`{|}~' </dev/urandom | head -c 13; echo)";

# Install Varbase based on type.
install_varbase_by_type() {
  local install_type="$1"

  if [[ "$install_type" == "minimal" ]]; then
    drush site-install varbase --yes \
      --site-name="$DDEV_PROJECT" \
      --account-name="$ADMIN_USER" \
      --account-pass="$webmaster_password" \
      --account-mail="$ADMIN_EMAIL" \
      --locale="$DEFAULT_LOCALE" \
      varbase_multilingual_configuration.enable_multilingual=NULL \
      varbase_extra_components.varbase_demo=NULL \
      varbase_extra_components.editoria11y=NULL \
      varbase_extra_components.vmi=NULL \
      varbase_extra_components.varbase_heroslider=NULL \
      varbase_extra_components.varbase_carousels=NULL \
      varbase_extra_components.varbase_search=NULL \
      varbase_extra_components.varbase_blog=NULL \
      varbase_extra_components.varbase_auth=NULL \
      varbase_extra_components.varbase_ai=NULL \
      varbase_extra_components.varbase_api=NULL \
      install_configure_form.enable_update_status_emails=NULL \
      --no-interaction \
      --debug \
      -vvv
  elif [[ "$install_type" == "full" ]]; then
    drush site-install varbase --yes \
      --site-name="$DDEV_PROJECT" \
      --account-name="$ADMIN_USER" \
      --account-pass="$webmaster_password" \
      --account-mail="$ADMIN_EMAIL" \
      --locale="$DEFAULT_LOCALE" \
      varbase_multilingual_configuration.enable_multilingual=1 \
      varbase_extra_components.varbase_demo=NULL \
      varbase_extra_components.editoria11y=1 \
      varbase_extra_components.vmi=1 \
      varbase_extra_components.varbase_heroslider=1 \
      varbase_extra_components.varbase_carousels=1 \
      varbase_extra_components.varbase_search=1 \
      varbase_extra_components.varbase_blog=1 \
      varbase_extra_components.varbase_auth=1 \
      varbase_extra_components.varbase_ai=1 \
      varbase_extra_components.varbase_api=1 \
      install_configure_form.enable_update_status_emails=NULL \
      --no-interaction \
      --debug \
      -vvv
    
    # Enable additional modules for full installation.
    drush pm:enable varbase_development --yes
    drush pm:enable varbase_landing --yes
    drush pm:enable varbase_content_planner --yes
    drush pm:enable varbase_media_instagram --yes
    drush pm:enable varbase_media_twitter --yes
    drush pm:enable social_auth_facebook --yes
    drush pm:enable social_auth_linkedin --yes
  elif [[ "$install_type" == "demo" ]]; then
    drush site-install varbase --yes \
      --site-name="$DDEV_PROJECT" \
      --account-name="$ADMIN_USER" \
      --account-pass="$webmaster_password" \
      --account-mail="$ADMIN_EMAIL" \
      --locale="$DEFAULT_LOCALE" \
      varbase_multilingual_configuration.enable_multilingual=1 \
      varbase_extra_components.varbase_demo=1 \
      varbase_extra_components.editoria11y=1 \
      varbase_extra_components.vmi=1 \
      varbase_extra_components.varbase_heroslider=1 \
      varbase_extra_components.varbase_carousels=1 \
      varbase_extra_components.varbase_search=1 \
      varbase_extra_components.varbase_blog=1 \
      varbase_extra_components.varbase_auth=1 \
      varbase_extra_components.varbase_ai=1 \
      varbase_extra_components.varbase_api=1 \
      install_configure_form.enable_update_status_emails=NULL \
      --no-interaction \
      --debug \
      -vvv

    # Enable additional modules for demo installation.
    drush pm:enable varbase_development --yes
    drush pm:enable social_auth_facebook --yes
    drush pm:enable social_auth_linkedin --yes
  fi

}

# Install Varbase based on type
install_varbase_by_type "$INSTALL_TYPE"

# Clear cache function
drush cache:rebuild

# Show completion message
echo "Varbase installation completed!"
echo " Project Basename: $DDEV_PROJECT"
echo " Project Primary URL: $DDEV_PRIMARY_URL"
echo " Username: $ADMIN_USER"
echo " Password: $webmaster_password"
